<script lang="ts">
  import { readable, type Readable } from 'svelte/store'
  import { BuildMethod, type GizmoLevel } from 'gizmos-env/common'
  import { ActionType } from 'gizmos-env/GizmosEnv'
  import type { BuildSolution, PlayerInfo } from 'gizmos-env/Player'
  import Me from './Me.svelte'
  import Gizmo from './Gizmo.svelte'
  import Energy from './Energy.svelte'
  import Log from './Log.svelte'
  import { render_level } from '$lib/helpers.js'
  import type { GizmosClient } from '$lib/client.js'
  import type { GizmosGame } from '$lib/game.js'

  const noop = () => undefined

  export let ongoing: boolean = true
  export let game: GizmosGame
  export let pending: Readable<boolean> = readable(false)
  export let pick: GizmosClient['pick'] = noop
  export let file: GizmosClient['file'] = noop
  export let file_from_research: GizmosClient['file_from_research'] = noop
  export let build: GizmosClient['build'] = noop
  export let build_from_filed: GizmosClient['build_from_filed'] = noop
  export let build_from_research: GizmosClient['build_from_research'] = noop
  export let research: GizmosClient['research'] = noop
  export let use_gizmo: GizmosClient['use_gizmo'] = noop
  export let give_up: GizmosClient['give_up'] = noop
  export let end: GizmosClient['end'] = noop

  const { log, player_list, me, env, observation, is_avail } = game

  $: console.log($observation)
  $: console.log($env, $env?.action_space)

  const LEVELS: GizmoLevel[] = [3, 2, 1]

  let build_dialog_element: HTMLDialogElement
  let build_dialog: {
    id: number
    method: BuildMethod
    solutions: BuildSolution[]
  } | null = null

  function on_build(me: PlayerInfo | null, solution: BuildSolution) {
    if (!me || !build_dialog) return
    const common_params = [
      build_dialog.id,
      solution.energy_num,
      solution.gizmos.map(g => g.id),
    ] as const
    switch (build_dialog.method) {
      case BuildMethod.DIRECTLY:
        build(...common_params)
        break
      case BuildMethod.FROM_FILED:
        build_from_filed(...common_params)
        break
      case BuildMethod.FROM_RESEARCH:
        build_from_research(...common_params)
        break
      default:
        throw new Error('unexpected build method')
    }
  }

  function show_build_dialog(
    id: number,
    method: BuildMethod,
    solutions: BuildSolution[]
  ) {
    build_dialog = {
      id,
      method,
      solutions,
    }
    if (build_dialog_element.open) return
    build_dialog_element.showModal()
  }

  let research_dialog_element: HTMLDialogElement
  $: if (research_dialog_element && $observation?.researching) {
    if (!research_dialog_element.open) {
      research_dialog_element.showModal()
    }
  }
  $: if (research_dialog_element && !$observation?.researching) {
    research_dialog_element.close()
  }

  $: if (build_dialog_element) {
    build_dialog_element.addEventListener('close', () => {
      build_dialog = null
    })
  }
</script>

{#if ongoing && $observation && $env}
  <div class:pending={$pending}>
    <div>
      <span>Stage: {$observation.curr_stage}</span>
      <span>
        Current player: {$player_list[$observation.curr_player_index].name}
      </span>
    </div>

    <Me {game} {use_gizmo} {give_up} {end} {show_build_dialog} />

    Board:
    <div class="m-10 flex flex-col gap-2 items-center">
      <div class:avail={$is_avail[ActionType.PICK]}>
        Pick energy:
        <div class="energy">
          {#each $observation.energy_board as energy}
            <button
              class={`w-5 h-5 rounded-full ${energy}`}
              on:click={() => pick(energy)}
            />
          {/each}
        </div>
        <div class="text-xs">
          remain: {$observation.energy_pool_num}
        </div>
      </div>
      {#each LEVELS as level}
        <div class="gizmos justify-center">
          <button
            class="w-36"
            class:avail={$is_avail[ActionType.RESEARCH]}
            disabled={!$is_avail[ActionType.RESEARCH]}
            on:click={() => research(level)}
          >
            <div>{render_level(level)}</div>
            {#if $me}
              <div>üîç: {$me.research_num}</div>
            {/if}
            <div class="text-xs">
              remain: {$observation.gizmos_pool_num[level]}
            </div>
          </button>
          {#each $observation.gizmos_board[level] as gizmo}
            {@const solutions = $is_avail[ActionType.BUILD]
              ? $env.build_solutions(gizmo.id, BuildMethod.DIRECTLY)
              : []}
            {@const can_build = solutions.length > 0}
            <div>
              <Gizmo info={gizmo} />
              <button
                class:avail={can_build}
                disabled={!can_build}
                on:click={() =>
                  show_build_dialog(gizmo.id, BuildMethod.DIRECTLY, solutions)}
              >
                üîß
              </button>
              <button
                class:avail={$is_avail[ActionType.FILE]}
                disabled={!$is_avail[ActionType.FILE]}
                on:click={() => file(gizmo.id)}
              >
                üìÅ
              </button>
            </div>
          {/each}
        </div>
      {/each}
    </div>
    Players:
    {#each $observation.players as player, i}
      <div class="font-bold text-lg">
        {$player_list[i].name}
      </div>
      <div>
        ‚≠ê:{player.point_token} üîÆ:{player.total_energy_num}/{player.max_energy_num}
        üìÅ:{player.filed.length}/{player.max_file_num} üîç:{player.research_num}
      </div>
      <div>Estimated score: {player.score}</div>
      <div class="energy">
        <div>Energy:</div>
        <Energy energy_num={player.energy_num} />
      </div>
      <div>
        Gizmos ({player.gizmos.length}/{$env.max_gizmos_num} Level3 {player
          .level3_gizmos.length}/{$env.max_level3_gizmos_num}):
      </div>
      <div class="gizmos-simple">
        {#each player.gizmos as gizmo}
          <Gizmo info={gizmo} simple={true} />
        {/each}
      </div>
      <div>
        File ({player.filed.length}/{player.max_file_num}):
      </div>
      <div class="gizmos-simple">
        {#each player.filed as gizmo}
          <Gizmo info={gizmo} />
        {/each}
      </div>
    {/each}
    <dialog bind:this={build_dialog_element}>
      <form method="dialog">
        {#if build_dialog}
          <div class="flex flex-col gap-2">
            {#each build_dialog.solutions as solution, i}
              <button class="avail" on:click={() => on_build($me, solution)}>
                Solution {i}:
                <div class="energy">
                  Energy cost:
                  <Energy energy_num={solution.energy_num} />
                </div>
                {#if solution.gizmos.length > 0}
                  <div class="gizmos-simple">
                    Gizmos cost:
                    {#each solution.gizmos as gizmo}
                      <Gizmo info={gizmo} simple={true} />
                    {/each}
                  </div>
                {/if}
              </button>
            {/each}
          </div>
        {/if}
        <button
          value="cancel"
          on:click={() => {
            if ($observation?.researching) {
              research_dialog_element.showModal()
            }
          }}
        >
          Cancel
        </button>
      </form>
    </dialog>
    <dialog bind:this={research_dialog_element}>
      <form method="dialog">
        {#if $observation.researching}
          <div class="gizmos">
            {#each $observation.researching.gizmos as g}
              {@const gizmo = $env.gizmo(g.id)}
              {@const solutions = $is_avail[ActionType.BUILD_FROM_RESEARCH]
                ? $env.build_solutions(gizmo, BuildMethod.FROM_RESEARCH)
                : []}
              {@const can_build = solutions.length > 0}
              {@const can_file = $is_avail[ActionType.FILE_FROM_RESEARCH]}
              <div>
                <Gizmo info={gizmo} />
                <button
                  class:avail={can_build}
                  disabled={!can_build}
                  on:click={() =>
                    show_build_dialog(
                      gizmo.id,
                      BuildMethod.FROM_RESEARCH,
                      solutions
                    )}
                >
                  üîß
                </button>
                <button
                  class:avail={can_file}
                  disabled={!can_file}
                  on:click={() => file_from_research(gizmo.id)}
                >
                  üìÅ
                </button>
              </div>
            {/each}
          </div>
        {/if}
        {#if $is_avail[ActionType.GIVE_UP]}
          <button class="avail" value="cancel" on:click={() => give_up()}>
            Give up research
          </button>
        {/if}
      </form>
    </dialog>
  </div>
{/if}
<Log log={$log} />

<style lang="postcss">
  .pending .avail {
    @apply pointer-events-none outline-none;
  }
</style>
